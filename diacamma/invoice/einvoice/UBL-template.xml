<?xml version="1.0" encoding="UTF-8"?>
<ubl:Invoice xmlns:ubl="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
    xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
    xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
    <cbc:UBLVersionID>2.1</cbc:UBLVersionID>
    <cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:fdc:peppol.eu:2017:poacc:billing:3.0</cbc:CustomizationID>
    <cbc:ID>{{ bill.num_txt }}</cbc:ID>
    <cbc:IssueDate>{{ bill.date|date:"Y-m-d" }}</cbc:IssueDate>
    <cbc:InvoiceTypeCode listID="UN/ECE 1001 Subset" listAgencyID="6">380</cbc:InvoiceTypeCode>
    <cbc:DocumentCurrencyCode listID="ISO 4217 Alpha" listAgencyID="6">{{ currency_code }}</cbc:DocumentCurrencyCode>
    <cac:AccountingSupplierParty>
        <cac:Party>
            <cbc:EndpointID schemeID="0088">{{ seller.legal_identification }}</cbc:EndpointID>
            <cac:PartyName>
                <cbc:Name>{{ seller }}</cbc:Name>
            </cac:PartyName>
            <cac:PostalAddress>
                <cbc:StreetName>{{ seller.contact.address_list.0 }}</cbc:StreetName>
                <cbc:AdditionalStreetName>{{ seller.contact.address_list.1 }}</cbc:AdditionalStreetName>
                <cbc:CityName>{{ seller.contact.city }}</cbc:CityName>
                <cbc:PostalZone>{{ seller.contact.postal_code }}</cbc:PostalZone>
                <cac:Country>
                    <cbc:IdentificationCode listID="ISO3166-1" listAgencyID="6">{{ seller.contact.country_id }}</cbc:IdentificationCode>
                </cac:Country>
            </cac:PostalAddress>
            <cac:PartyTaxScheme>
                <cbc:CompanyID>{{ seller.vat_identification }}</cbc:CompanyID>
                <cac:TaxScheme>
                    <cbc:ID schemeID="UN/ECE 5153" schemeAgencyID="6">VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:PartyTaxScheme>
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ seller }}</cbc:RegistrationName>
                <cbc:CompanyID schemeID="0003">{{ seller.legal_identification }}</cbc:CompanyID>
            </cac:PartyLegalEntity>
            <cac:Contact>
                <cbc:Telephone>{{ seller.contact.tel1 }}</cbc:Telephone>
                <cbc:ElectronicMail>{{ seller.contact.email }}</cbc:ElectronicMail>
            </cac:Contact>
        </cac:Party>
    </cac:AccountingSupplierParty>
    <cac:AccountingCustomerParty>
        <cac:Party>
            <cbc:EndpointID schemeID="0088">{{ bill.third.legal_identification }}</cbc:EndpointID>
            <cac:PartyName>
                <cbc:Name>{{ bill.third }}</cbc:Name>
            </cac:PartyName>
            <cac:PostalAddress>
                <cbc:StreetName>{{ bill.third.contact.address_list.0 }}</cbc:StreetName>
                <cbc:AdditionalStreetName>{{ bill.third.contact.address_list.1 }}</cbc:AdditionalStreetName>
                <cbc:CityName>{{ seller.contact.city }}</cbc:CityName>
                <cbc:PostalZone>{{ bill.third.contact.postal_code }}</cbc:PostalZone>
                <cac:Country>
                    <cbc:IdentificationCode listID="ISO3166-1" listAgencyID="6">{{ bill.third.contact.country_id }}</cbc:IdentificationCode>
                </cac:Country>
            </cac:PostalAddress>
            <cac:PartyTaxScheme>
                <cbc:CompanyID schemeID="0003">{{ bill.third.vat_identification }}</cbc:CompanyID>
                <cac:TaxScheme>
                    <cbc:ID schemeID="UN/ECE 5153" schemeAgencyID="6">VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:PartyTaxScheme>
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ bill.third }}</cbc:RegistrationName>
                <cbc:CompanyID schemeID="0003" schemeAgencyID="ZZZ">{{ bill.third.legal_identification }}</cbc:CompanyID>
            </cac:PartyLegalEntity>
            <cac:Contact>
                <cbc:Telephone>{{ bill.third.contact.tel1 }}</cbc:Telephone>
                <cbc:ElectronicMail>{{ bill.third.contact.email }}</cbc:ElectronicMail>
            </cac:Contact>
        </cac:Party>
    </cac:AccountingCustomerParty>
    <cac:PaymentTerms>
        <cbc:Note>{{ bill.description }}</cbc:Note>
    </cac:PaymentTerms>    
    <cac:TaxTotal>
        <cbc:TaxAmount currencyID="{{ currency_code }}">{{ bill.get_tax_sum }}</cbc:TaxAmount>
        {% for vat_item in bill.vat_list_info %}
        <cac:TaxSubtotal>
            <cbc:TaxableAmount currencyID="{{ currency_code }}">{{ vat_item.2 }}</cbc:TaxableAmount>
            <cbc:TaxAmount currencyID="{{ currency_code }}">{{ vat_item.1 }}</cbc:TaxAmount>
            <cac:TaxCategory>
                <cbc:ID schemeID="UN/ECE 5305" schemeAgencyID="6">S</cbc:ID>
                <cbc:Percent>{{ vat_item.0 }}</cbc:Percent>
                <cac:TaxScheme>
                    <cbc:ID schemeID="UN/ECE 5153" schemeAgencyID="6">VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:TaxCategory>
        </cac:TaxSubtotal>
        {% endfor %}
    </cac:TaxTotal>
    <cac:LegalMonetaryTotal>
        <cbc:LineExtensionAmount currencyID="{{ currency_code }}">{{ bill.get_total_excltax }}</cbc:LineExtensionAmount>
        <cbc:TaxExclusiveAmount currencyID="{{ currency_code }}">{{ bill.get_total_excltax }}</cbc:TaxExclusiveAmount>
        <cbc:TaxInclusiveAmount currencyID="{{ currency_code }}">{{ bill.get_total_incltax }}</cbc:TaxInclusiveAmount>
        <cbc:PrepaidAmount currencyID="{{ currency_code }}">{{ bill.get_total_payed }}</cbc:PrepaidAmount>
        <cbc:PayableAmount currencyID="{{ currency_code }}">{{ bill.get_total_incltax }}</cbc:PayableAmount>
    </cac:LegalMonetaryTotal>
    {% for detail in bill.detail_set.all %}
    <cac:InvoiceLine>
        <cbc:ID>{{ detail.id }}</cbc:ID>
        <cbc:Note>Scratch on box</cbc:Note>
        <cbc:InvoicedQuantity unitCode="C62">{{ detail.quantity|floatformat:2 }}</cbc:InvoicedQuantity>
        <cbc:LineExtensionAmount currencyID="{{ currency_code }}">{{ detail.total_excltax }}</cbc:LineExtensionAmount>
        <cac:Item>
            <cbc:Name>{{ detail.get_designation_txt }}</cbc:Name>
            <cac:SellersItemIdentification>
                <cbc:ID>{{ detail.article.reference }}</cbc:ID>
            </cac:SellersItemIdentification>
            <ClassifiedTaxCategory
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
                {% if detail.get_vat_rate_value == '0.00' %}
                <cbc:ID schemeID="UN/ECE 5305">E</cbc:ID>
                {% else %}
                <cbc:ID schemeID="UN/ECE 5305">S</cbc:ID>
                {% endif %}
                <cbc:Percent>{{ detail.get_vat_rate_value }}</cbc:Percent>
                <TaxScheme>
                    <cbc:ID schemeID="UN/ECE 5153" schemeAgencyID="6">VAT</cbc:ID>
                </TaxScheme>
            </ClassifiedTaxCategory>
        </cac:Item>
        <cac:Price>
            <cbc:PriceAmount currencyID="{{ currency_code }}">{{ detail.price_txt }}</cbc:PriceAmount>
            <cbc:BaseQuantity unitCode="C62">{{ detail.quantity_txt }}</cbc:BaseQuantity>
            <cac:AllowanceCharge>
                <cbc:ChargeIndicator>false</cbc:ChargeIndicator>
                <cbc:Amount currencyID="{{ currency_code }}">{{ detail.get_reduce }}</cbc:Amount>
            </cac:AllowanceCharge>
        </cac:Price>
    </cac:InvoiceLine>
    {% endfor %}
</ubl:Invoice>